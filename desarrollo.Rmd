---
title: "Desarrollo"
author: "Alejandro Brenes, Santiago Fernández, Eyeri Méndez y Erick Venegas"
date: "`r Sys.Date()`"
output: html_document
---

# Preparación

Se inicia cargando las librerías necesarias.

```{r librerias}
pacman::p_load(cowplot,
               dplyr,
               ggplot2,
               jsonlite,
               lubridate,
               corrplot
               )
```

Se procede a cargar los datos.

```{r carga_datos}
eventos_EEUU <- fromJSON("data/Eventos EEUU.json")[[2]]
```

Algunas correcciones de formato.

```{r correccion_formato}
# Formato de la fecha
eventos_EEUU$begDate <-
  as.Date(as.character(eventos_EEUU$begDate), format = "%Y%m%d")
eventos_EEUU$endDate <-
  as.Date(as.character(eventos_EEUU$endDate), format = "%Y%m%d")

# Nombre de las columnas (coste en millones de dólares y coste ajustado al 2024)
colnames(eventos_EEUU) <-
  c(
    "nombre",
    "desastre",
    "inicio",
    "final",
    "coste_ajustado",
    "coste_original",
    "muertes"
  )

# Columna de duración del desastre (en días)
eventos_EEUU <- eventos_EEUU %>%
  mutate(duracion = as.integer(final - inicio))

# Se ponen los nombres de los desastres en español
eventos_EEUU <- eventos_EEUU %>%
  mutate(
    desastre = case_when(
      desastre == "Flooding" ~ "Inundación",
      desastre == "Tropical Cyclone" ~ "Ciclón tropical",
      desastre == "Drought" ~ "Sequía",
      desastre == "Freeze" ~ "Helada",
      desastre == "Severe Storm" ~ "Tormenta severa",
      desastre == "Winter Storm" ~ "Tormenta de nieve",
      desastre == "Wildfire" ~ "Incendio"
    )
  )

# Se ordena por fecha de inicio
eventos_EEUU <- eventos_EEUU[order(eventos_EEUU$inicio), ]
rownames(eventos_EEUU) <- NULL
```

Se agrega la variable de estación climatológica.

```{r estacion}
eventos_EEUU <- eventos_EEUU %>%
  mutate(
    estacion = case_when(
      month(inicio) %in% c(12, 1, 2) ~ "Invierno",
      month(inicio) %in% c(3, 4, 5)  ~ "Primavera",
      month(inicio) %in% c(6, 7, 8)  ~ "Verano",
      month(inicio) %in% c(9, 10, 11) ~ "Otoño"
    )
  )
```

# Gráficos

## Variables individuales

Inicialmente, empezamos observando las variables de forma individual.

```{r individuales, message = FALSE}
# DataFrame auxiliar con la cantidad de desastres por año (usando la fecha de inicio)
conteo_anual <- eventos_EEUU %>%
  group_by(anno = year(eventos_EEUU$inicio)) %>%
  summarise(cantidad = n())

# Gráfico de barras de la cantidad de desastres por año
ggplot(conteo_anual, aes(x = anno, y = cantidad)) +
  geom_col(fill = "darkgreen") +
  labs(
    x = "Año",
    y = "Cantidad de desastres"
  ) +
  theme_cowplot()

# Histograma del coste ajustado
ggplot(eventos_EEUU, aes(x = coste_ajustado)) +
  geom_histogram(fill = "salmon2", color = "black") +
  labs(x = "Coste ajustado (Millones de dólares)", y = "Cantidad de desastres") +
  theme_cowplot()

# Histograma de la duración de los desastres
ggplot(eventos_EEUU, aes(x = duracion)) +
  geom_histogram(fill = "orangered", color = "black") +
  labs(x = "Duración del desastre (días)", y = "Cantidad de desastres") +
  theme_cowplot()

# Gráfico de barras del tipo de desastres
ggplot(eventos_EEUU, aes(x = desastre)) +
  geom_bar(fill = "#54008B", color = "black") +
  labs(x = "Tipo de desastre", y = "Cantidad") +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Histograma de cantidad de muertes
ggplot(eventos_EEUU, aes(x = muertes)) +
  geom_histogram(fill = "#54008B", color = "black", binwidth = 50) +
  labs(x = "Muertes", y = "Cantidad de desastres") +
  theme_cowplot()

# Histograma de diferencia de días entre el inicio de un desastre y el siguiente
ggplot(data.frame(diferencia = as.integer(diff.Date(
  eventos_EEUU$inicio
))), aes(x = diferencia)) +
  geom_histogram(fill = "#54008B", color = "black", binwidth = 14) +
  labs(x = "Diferencia de días", y = "Cantidad de desastres") +
  theme_cowplot()
```

## Series de tiempo

Posteriormente, se muestran algunas series de tiempo de las variables disponibles. Las fechas son tomadas del inicio del desastre natural.

```{r series_tiempo}
# Serie de tiempo del coste ajustado
eventos_EEUU %>%
  ggplot(aes(inicio, coste_ajustado)) +
  geom_line(color = "#001889") +
  geom_point(color = "#54008B") +
  labs(x = "Fecha", y = "Coste ajustado (millones de dólares)") +
  theme_cowplot()

# Serie de tiempo de las muertes
eventos_EEUU %>%
  ggplot(aes(inicio, muertes)) +
  geom_line(color = "#001889") +
  geom_point(color = "#54008B") +
  labs(x = "Fecha", y = "Muertes") +
  theme_cowplot()

# Serie de tiempo de la duración
eventos_EEUU %>%
  ggplot(aes(inicio, duracion)) +
  geom_line(color = "#001889") +
  geom_point(color = "#54008B") +
  labs(x = "Fecha", y = "Duración del desastre (días)") +
  theme_cowplot()

# Guardamos los datos mensuales del coste ajustado
coste_ts <- eventos_EEUU %>%
  mutate(mes = format(as.Date(inicio), "%Y-%m")) %>%
  group_by(mes) %>%
  summarise(coste_total = sum(coste_ajustado, na.rm = TRUE)) %>%
  ungroup()

# Convertimos los datos a un objeto ts
coste_ts <- ts(coste_ts$coste_total, 
            start = c(as.numeric(substr(coste_ts$mes[1], 1, 4)), 
                      as.numeric(substr(coste_ts$mes[1], 6, 7))),
            frequency = 12)

# Monthplot del coste ajustado
monthplot(
  coste_ts, labels = c("Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago",
    "Sep", "Oct", "Nov", "Dic"),
  xlab = "Mes", ylab = "Coste ajustado (Millones de dólares)", 
  col = "darkmagenta", col.base = "tomato"
)
```

## Filtrados

A continuación, se procede con algunos gráficos que poseen filtros con respecto a algunas variables, esto para interpretar mejor la distribución de los diversos desastres.

```{r filtros}
# Duración filtrada por tipo de desastre
ggplot(eventos_EEUU, aes(x = desastre, y = duracion, fill = desastre)) +
  geom_boxplot() +
  labs(x = "Tipo de desastre", y = "Duración del desastre (días)") +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1),
        legend.position = "none") +
  scale_fill_manual(
    values = c(
      "Inundación" = "#001889",
      "Tormenta severa" = "#54008B",
      "Tormenta de nieve" = "#81008D",
      "Incendio" = "#A40A8A",
      "Ciclón tropical" = "#C03180",
      "Sequía" = "#D5536D",
      "Helada" = "#E4764E"
    )
  )

# Gráfico de barras apiladas de tipo de desastre según la estación
ggplot(eventos_EEUU, aes(x = estacion, fill = desastre)) +
  geom_bar() +
  labs(
    x = "Estación del año",
    y = "Cantidad de desastres",
    fill = "Tipo de desastre"
  ) +
  theme_cowplot() +
  scale_fill_manual(
    values = c(
      "Inundación" = "cyan3",
      "Tormenta severa" = "violet",
      "Tormenta de nieve" = "mediumvioletred",
      "Incendio" = "springgreen",
      "Ciclón tropical" = "darkorange",
      "Sequía" = "tomato2",
      "Helada" = "gold2"
    )
  )

# Muertes filtradas por tipo de desastre
ggplot(eventos_EEUU, aes(x = desastre, y = muertes, fill = desastre)) +
  geom_boxplot() +
  labs(x = "Tipo de desastre", y = "Muertes") +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1),
        legend.position = "none") +
  scale_fill_manual(
    values = c(
      "Inundación" = "#001889",
      "Tormenta severa" = "#54008B",
      "Tormenta de nieve" = "#81008D",
      "Incendio" = "#A40A8A",
      "Ciclón tropical" = "#C03180",
      "Sequía" = "#D5536D",
      "Helada" = "#E4764E"
    )
  )

# Coste ajustado filtrado por tipo de desastre
ggplot(eventos_EEUU,
       aes(x = desastre, y = coste_ajustado, fill = desastre)) +
  geom_boxplot() +
  labs(x = "Tipo de desastre", y = "Coste ajustado (millones de dólares)") +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1),
        legend.position = "none") +
  scale_fill_manual(
    values = c(
      "Inundación" = "#001889",
      "Tormenta severa" = "#54008B",
      "Tormenta de nieve" = "#81008D",
      "Incendio" = "#A40A8A",
      "Ciclón tropical" = "#C03180",
      "Sequía" = "#D5536D",
      "Helada" = "#E4764E"
    )
  )

# Coste ajustado filtrado por estación del año
ggplot(eventos_EEUU,
       aes(x = estacion, y = coste_ajustado, fill = estacion)) +
  geom_boxplot() +
  labs(x = "Estación", y = "Coste ajustado (millones de dólares)") +
  theme_cowplot() +
  theme(legend.position = "none") +
  scale_fill_manual(
    values = c(
      "Primavera" = "#54008B",
      "Verano" = "#81008D",
      "Otoño" = "#A40A8A",
      "Invierno" = "#C03180"
    )
  )
```

## Matriz de correlación

A continuación se realiza la matriz de correlación entre las variables de coste ajustado, muertes y duración.

```{r matriz_corr}
corrplot(cor(data.frame(coste_ajustado = eventos_EEUU$coste_ajustado, 
                    muertes = eventos_EEUU$muertes, 
                    duracion = eventos_EEUU$duracion)), method = "square", 
         type = "upper", tl.col = "black", tl.srt = 60, addCoef.col = "black")
```

Como se muestra una correlación considerable entre el coste ajustado y las muertes, se creará un gráfico de dispersión entre estas variables con una recta de regresión para visualizar la tendencia.

```{r grafico_dispersion_lm}
ggplot(eventos_EEUU, aes(x = muertes, y = coste_ajustado)) +
  geom_point(color = "mediumorchid", size = 2) +
  geom_smooth(method = "lm", se = TRUE, color = "springgreen2") +
  labs(x = "Muertes", y = "Coste ajustado (Millones de dólares)") +
  theme_cowplot()
```



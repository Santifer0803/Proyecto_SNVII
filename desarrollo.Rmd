---
title: "Desarrollo"
author: "Alejandro Brenes, Santiago Fernández, Eyeri Méndez y Erick Venegas"
date: "`r Sys.Date()`"
output: html_document
---

# Preparación

Se inicia cargando las librerías necesarias.

```{r librerias}
pacman::p_load(corrplot,
               cowplot,
               dplyr,
               ggplot2,
               evd,
               jsonlite,
               lubridate
               )
```

Se procede a cargar los datos.

```{r carga_datos}
eventos_EEUU <- fromJSON("data/Eventos EEUU.json")[[2]]
```

Algunas correcciones de formato.

```{r correccion_formato}
# Formato de la fecha
eventos_EEUU$begDate <-
  as.Date(as.character(eventos_EEUU$begDate), format = "%Y%m%d")
eventos_EEUU$endDate <-
  as.Date(as.character(eventos_EEUU$endDate), format = "%Y%m%d")

# Nombre de las columnas (coste en millones de dólares y coste ajustado al 2024)
colnames(eventos_EEUU) <-
  c(
    "nombre",
    "desastre",
    "inicio",
    "final",
    "coste_ajustado",
    "coste_original",
    "muertes"
  )

# Columna de duración del desastre (en días)
eventos_EEUU <- eventos_EEUU %>%
  mutate(duracion = as.integer(final - inicio))

# Se ponen los nombres de los desastres en español
eventos_EEUU <- eventos_EEUU %>%
  mutate(
    desastre = case_when(
      desastre == "Flooding" ~ "Inundación",
      desastre == "Tropical Cyclone" ~ "Ciclón tropical",
      desastre == "Drought" ~ "Sequía",
      desastre == "Freeze" ~ "Helada",
      desastre == "Severe Storm" ~ "Tormenta severa",
      desastre == "Winter Storm" ~ "Tormenta de nieve",
      desastre == "Wildfire" ~ "Incendio"
    )
  )

# Se ordena por fecha de inicio
eventos_EEUU <- eventos_EEUU[order(eventos_EEUU$inicio), ]
rownames(eventos_EEUU) <- NULL
```

Se agrega la variable de estación climatológica.

```{r estacion}
eventos_EEUU <- eventos_EEUU %>%
  mutate(
    estacion = case_when(
      month(inicio) %in% c(12, 1, 2) ~ "Invierno",
      month(inicio) %in% c(3, 4, 5)  ~ "Primavera",
      month(inicio) %in% c(6, 7, 8)  ~ "Verano",
      month(inicio) %in% c(9, 10, 11) ~ "Otoño"
    )
  )
```

# Análisis exploratorio de datos

## Variables individuales

Inicialmente, empezamos observando las variables de forma individual.

```{r individuales, message = FALSE}
# DataFrame auxiliar con la cantidad de desastres por año (usando la fecha de inicio)
conteo_anual <- eventos_EEUU %>%
  group_by(anno = year(eventos_EEUU$inicio)) %>%
  summarise(cantidad = n())

# Gráfico de barras de la cantidad de desastres por año
ggplot(conteo_anual, aes(x = anno, y = cantidad)) +
  geom_col(fill = "#54008B") +
  labs(
    x = "Año",
    y = "Cantidad de desastres"
  ) +
  theme_cowplot()

# Histograma del coste ajustado
ggplot(eventos_EEUU, aes(x = coste_ajustado)) +
  geom_histogram(fill = "#54008B", color = "black") +
  labs(x = "Coste ajustado (Millones de dólares)", y = "Cantidad de desastres") +
  theme_cowplot()

# Histograma de la duración de los desastres
ggplot(eventos_EEUU, aes(x = duracion)) +
  geom_histogram(fill = "#54008B", color = "black") +
  labs(x = "Duración del desastre (días)", y = "Cantidad de desastres") +
  theme_cowplot()

# Gráfico de barras del tipo de desastres
ggplot(eventos_EEUU, aes(x = desastre)) +
  geom_bar(fill = "#54008B", color = "black") +
  labs(x = "Tipo de desastre", y = "Cantidad") +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Histograma de cantidad de muertes
ggplot(eventos_EEUU, aes(x = muertes)) +
  geom_histogram(fill = "#54008B", color = "black", binwidth = 50) +
  labs(x = "Muertes", y = "Cantidad de desastres") +
  theme_cowplot()

# Histograma de diferencia de días entre el inicio de un desastre y el siguiente
ggplot(data.frame(diferencia = as.integer(diff.Date(
  eventos_EEUU$inicio
))), aes(x = diferencia)) +
  geom_histogram(fill = "#54008B", color = "black", binwidth = 14) +
  labs(x = "Diferencia de días", y = "Cantidad de desastres") +
  theme_cowplot()
```

## Series de tiempo

Posteriormente, se muestran algunas series de tiempo de las variables disponibles. Las fechas son tomadas del inicio del desastre natural.

```{r series_tiempo}
# Serie de tiempo del coste ajustado
eventos_EEUU %>%
  ggplot(aes(inicio, coste_ajustado)) +
  geom_line(color = "#001889") +
  geom_point(color = "#54008B") +
  labs(x = "Fecha", y = "Coste ajustado (millones de dólares)") +
  theme_cowplot()

# Serie de tiempo de las muertes
eventos_EEUU %>%
  ggplot(aes(inicio, muertes)) +
  geom_line(color = "#001889") +
  geom_point(color = "#54008B") +
  labs(x = "Fecha", y = "Muertes") +
  theme_cowplot()

# Serie de tiempo de la duración
eventos_EEUU %>%
  ggplot(aes(inicio, duracion)) +
  geom_line(color = "#001889") +
  geom_point(color = "#54008B") +
  labs(x = "Fecha", y = "Duración del desastre (días)") +
  theme_cowplot()

# Guardamos los datos mensuales del coste ajustado
coste_ts <- eventos_EEUU %>%
  mutate(mes = format(as.Date(inicio), "%Y-%m")) %>%
  group_by(mes) %>%
  summarise(coste_total = sum(coste_ajustado, na.rm = TRUE)) %>%
  ungroup()

# Convertimos los datos a un objeto ts
coste_ts <- ts(coste_ts$coste_total, 
            start = c(as.numeric(substr(coste_ts$mes[1], 1, 4)), 
                      as.numeric(substr(coste_ts$mes[1], 6, 7))),
            frequency = 12)

# Monthplot del coste ajustado
monthplot(
  coste_ts, labels = c("Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago",
    "Sep", "Oct", "Nov", "Dic"),
  xlab = "Mes", ylab = "Coste ajustado (Millones de dólares)", 
  col = "#54008B", col.base = "#001889"
)
```

## Filtrados

A continuación, se procede con algunos gráficos que poseen filtros con respecto a algunas variables, esto para interpretar mejor la distribución de los diversos desastres.

```{r filtros}
# Duración filtrada por tipo de desastre
ggplot(eventos_EEUU, aes(x = desastre, y = duracion, fill = desastre)) +
  geom_boxplot() +
  labs(x = "Tipo de desastre", y = "Duración del desastre (días)") +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1),
        legend.position = "none") +
  scale_fill_manual(
    values = c(
      "Inundación" = "#001889",
      "Tormenta severa" = "#54008B",
      "Tormenta de nieve" = "#81008D",
      "Incendio" = "#A40A8A",
      "Ciclón tropical" = "#C03180",
      "Sequía" = "#D5536D",
      "Helada" = "#E4764E"
    )
  )

# Gráfico de barras apiladas de tipo de desastre según la estación
ggplot(eventos_EEUU, aes(x = estacion, fill = desastre)) +
  geom_bar() +
  labs(
    x = "Estación del año",
    y = "Cantidad de desastres",
    fill = "Tipo de desastre"
  ) +
  theme_cowplot() +
  scale_fill_manual(
    values = c(
      "Inundación" = "cyan3",
      "Tormenta severa" = "violet",
      "Tormenta de nieve" = "mediumvioletred",
      "Incendio" = "springgreen",
      "Ciclón tropical" = "darkorange",
      "Sequía" = "tomato2",
      "Helada" = "gold2"
    )
  )

# Muertes filtradas por tipo de desastre
ggplot(eventos_EEUU, aes(x = desastre, y = muertes, fill = desastre)) +
  geom_boxplot() +
  labs(x = "Tipo de desastre", y = "Muertes") +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1),
        legend.position = "none") +
  scale_fill_manual(
    values = c(
      "Inundación" = "#001889",
      "Tormenta severa" = "#54008B",
      "Tormenta de nieve" = "#81008D",
      "Incendio" = "#A40A8A",
      "Ciclón tropical" = "#C03180",
      "Sequía" = "#D5536D",
      "Helada" = "#E4764E"
    )
  )

# Coste ajustado filtrado por tipo de desastre
ggplot(eventos_EEUU,
       aes(x = desastre, y = coste_ajustado, fill = desastre)) +
  geom_boxplot() +
  labs(x = "Tipo de desastre", y = "Coste ajustado (millones de dólares)") +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1),
        legend.position = "none") +
  scale_fill_manual(
    values = c(
      "Inundación" = "#001889",
      "Tormenta severa" = "#54008B",
      "Tormenta de nieve" = "#81008D",
      "Incendio" = "#A40A8A",
      "Ciclón tropical" = "#C03180",
      "Sequía" = "#D5536D",
      "Helada" = "#E4764E"
    )
  )

# Coste ajustado filtrado por estación del año
ggplot(eventos_EEUU,
       aes(x = estacion, y = coste_ajustado, fill = estacion)) +
  geom_boxplot() +
  labs(x = "Estación", y = "Coste ajustado (millones de dólares)") +
  theme_cowplot() +
  theme(legend.position = "none") +
  scale_fill_manual(
    values = c(
      "Primavera" = "#54008B",
      "Verano" = "#81008D",
      "Otoño" = "#A40A8A",
      "Invierno" = "#C03180"
    )
  )
```

## Matriz de correlación

A continuación se realiza la matriz de correlación entre las variables de coste ajustado, muertes y duración.

```{r matriz_corr}
corrplot(cor(data.frame(coste_ajustado = eventos_EEUU$coste_ajustado, 
                    muertes = eventos_EEUU$muertes, 
                    duracion = eventos_EEUU$duracion)), method = "square", 
         type = "upper", tl.col = "black", tl.srt = 60, addCoef.col = "black")
```

Como se muestra una correlación considerable entre el coste ajustado y las muertes, se creará un gráfico de dispersión entre estas variables con una recta de regresión para visualizar la tendencia.

```{r grafico_dispersion_lm}
ggplot(eventos_EEUU, aes(x = muertes, y = coste_ajustado / 1000)) +
  geom_point(color = "mediumorchid", size = 2) +
  geom_smooth(method = "loess", se = TRUE, color = "springgreen2") +
  labs(x = "Muertes", y = "Coste ajustado (Miles de millones de dólares)") +
  theme_cowplot()
```

# Desarrollo del modelo

## Ajuste del modelo

Inicialmente, se realiza un ajuste de los valores disponibles a través de máxima verosimilitud. Esto corresponde a ajustar una GEV con unos parámetros concretos, pues, se tienen los valores máximos de los desastres naturales.

```{r ajuste_modelo}
# Se fija una semilla para reproducibilidad
set.seed(333)

# Se realiza el ajuste por máxima veosimilitud (se ajusta la escala para asegurar convergencia)
(optimizacion <- fgev(eventos_EEUU$coste_ajustado / 1000))
```

## Resultados del modelo (caso base)

Se inicia mostrando una comparación de la densidad teórica y de la densidad obtenida en los datos.

```{r densidades}
# Densidad teórica de la GEV
densidad_teorica <-
  dgev(
    seq(
      min(eventos_EEUU$coste_ajustado / 1000),
      max(eventos_EEUU$coste_ajustado / 1000),
      length.out = 1000
    ),
    loc = optimizacion$estimate["loc"],
    scale = optimizacion$estimate["scale"],
    shape = optimizacion$estimate["shape"]
  )

# Se crea el gráfico para ver la distribución teórica de la GEV
data.frame(x = seq(
  min(eventos_EEUU$coste_ajustado / 1000),
  max(eventos_EEUU$coste_ajustado / 1000),
  length.out = 1000
),
dens = densidad_teorica) %>%
  ggplot() +
  geom_line(
    aes(x = x, y = dens),
    color = "#81008D",
    linewidth = 1.2
  ) +
  labs(x = "Coste ajustado (miles de millones de dólares)",
       y = "Densidad") +
  theme_cowplot()

# Gráfico de la densidad obtenida con los datos
eventos_EEUU %>%
  ggplot() +
  geom_density(
    aes(x = coste_ajustado / 1000),
    color = "#A40A8A",
    alpha = 0.6
  ) +
  labs(x = "Coste ajustado (miles de millones de dólares)",
       y = "Densidad") +
  theme_cowplot()
```

Debido a que se tienen 403 datos, la densidad de estos se ve más afectada por los casos más extremos, como el Huracán Katrina, lo cual disminuye la probabilidad en los valores bajos y lo aumenta en los altos. En la densidad teórica se pueden agregar los datos deseados, lo cual hace que se muestren probabilidades más realistas.

Se procede a mostrar algunos cuantiles de la distribución correspondiente.

```{r cuantiles_teoricos}
# Cuantiles 50%, 90%, 95% y 99% en miles de millones de dólares
cuantiles <- qgev(
  c(0.5, 0.9, 0.95, 0.99),
  loc = optimizacion$estimate["loc"],
  scale = optimizacion$estimate["scale"],
  shape = optimizacion$estimate["shape"],
  lower.tail = TRUE
)

# Tabla de resumen
data.frame("cuantiles" = c(0.5, 0.9, 0.95, 0.99),
           "valor" = cuantiles * 1e9)
```

La interpretación de la tabla es la siguiente: teóricamente, hay un $50\%$ de probabilidades de que el coste del desastre natural extremo sea menor o igual a $\$2415841651$. Análogamente con los otros valores.

Por otro lado, el Huracán Katrina es el desastre natural que mayor coste ha tenido en la historia de EEUU, por lo que se procede a calcular el complemento de su percentil.

```{r cuantil_maximo}
# Coste del Huracán Katrina ajustado al 2024
eventos_EEUU[which.max(eventos_EEUU$coste_ajustado), "coste_ajustado"] / 1000

# Complemento del percentil más alto (Huracán Katrina)
pgev(
  (eventos_EEUU[which.max(eventos_EEUU$coste_ajustado), "coste_ajustado"] / 1000),
  loc = optimizacion$estimate["loc"],
  scale = optimizacion$estimate["scale"],
  shape = optimizacion$estimate["shape"],
  lower.tail = FALSE
)
```

Se calcula el complemento de su percentil debido a que su interpretación resulta más significativa. Si nos basamos en la historia registrada, existe una probabilidad del $0.79\%$ de que, teniendo un desastre natural extremo (que alcance los 1000 millones de dólares en daños con la inflación del 2024), este supere el coste ajustado a 2024 de la catástrofe natural más costosa de la historia de EEUU, correspondiente al Huracán Katrina.

Hay que decir que el porcentaje anterior se presenta de forma teórica, pues las condiciones del Huracán Katrina fueron muy concretas y una gran parte de los daños causados fueron debido al fallo del sistema de diques de Nueva Orleans (buscar referencia). Esto evidencia un grave error humano, el cual, podría haber reducido los daños causados si se hubiera evitado.

## Resultados del modelo (caso pesimista)

Todos los resultados anteriores fueron presentados con los parámetros esperados de la estimación de máxima verosimilitud. No obstante, en el presente análisis se muestra un caso pesimista, en el cual se ajusta la distribución con los parámetros de mayor valor (según el error estándar de cada uno, multiplicado por el cuantil $99\%$ de una normal).

```{r ajuste_pesimista}
# Se le suma el error estándar con una normal(0, 1) a los parámetros estimados
param_pes <- optimizacion$estimate + qnorm((1 + 0.99) / 2) * optimizacion$std.err

# Cuantiles 50%, 90%, 95% y 99% en miles de millones de dólares
cuantiles <- qgev(
  c(0.5, 0.9, 0.95, 0.99),
  loc = param_pes[1],
  scale = param_pes[2],
  shape = param_pes[3],
  lower.tail = TRUE
)

# Tabla de resumen
data.frame("cuantiles" = c(0.5, 0.9, 0.95, 0.99),
           "valor" = cuantiles * 1e9)

# Complemento del percentil más alto (Huracán Katrina)
pgev(
  (eventos_EEUU[which.max(eventos_EEUU$coste_ajustado), "coste_ajustado"] / 1000),
  loc = param_pes[1],
  scale = param_pes[2],
  shape = param_pes[3],
  lower.tail = FALSE
)
```

El análisis es análogo, aunque se puede ver que, en el caso más extremo (pesimista) que se podría considerar, los valores aumentan considerablemente.